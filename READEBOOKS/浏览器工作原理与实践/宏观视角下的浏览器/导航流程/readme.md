### 04 | 导航流程：从输入URL到页面展示，这中间发生了什么？

- 浏览器进程: 主要负责用户交互、子进程管理和文件储存等功能。
- 网络进程: 是面向渲染进程和浏览器进程等提供网络下载功能。
- 渲染进程: 主要职责是把从网络下载的 HTML、JavaScript、CSS、图片等资源解析为可以显示和交互的页面。
    因为渲染进程所有的内容都是通过网络获取的，会存在一些恶意代码利用浏览器漏洞对系统进行攻击，所以运行在渲染进程里面的代码是不被信任的。这也是为什么 Chrome 会让渲染进程运行在安全沙箱里，就是为了保证系统的安全。

进程间的配合核心过程：
1. 首先，用户从浏览器进程里**输入请求信息**；
2. 然后，网络进程**发起 URL 请求**；
3. 服务器响应 URL 请求之后，浏览器进程就又要开始**准备渲染进程**了；
4. 渲染进程准备好之后，需要先向渲染进程提交页面数据，我们称之为**提交文档**阶段；
5. 渲染进程接收完文档信息之后，便开始**解析页面和加载子资源**，完成页面的渲染。

# 1. 用户输入
- 当用户在地址栏中输入一个查询关键字时，地址栏会判断输入的关键字是搜索内容，还是请求的 URL
    1. 如果是搜索内容，地址栏会使用浏览器默认的搜索引擎，来合成新的带搜索关键字的 URL。
    2. 如果判断输入内容符合 URL 规则，比如输入的是 time.geekbang.org，那么地址栏会根据规则，把这段内容加上协议，合成为完整的 URL，如 https://time.geekbang.org。
回车进入加载状态。

# 2. URL 请求过程
1. 浏览器进程会通过进程间通信（IPC）把 URL 请求发送至网络进程。
2. 网络进程接收到 URL 请求后，会在这里发起真正的 URL 请求流程。
    - 首先，网络进程会查找本地缓存是否缓存了该资源
    如果有缓存资源，那么直接返回资源给浏览器进程；
    如果在缓存中没有查找到资源，那么直接进入网络请求流程。
    - 请求前
        1. 进行 DNS 解析，以获取请求域名的服务器 IP 地址。
        2. 如果请求协议是 HTTPS，那么还需要建立 TLS 连接。(安全传输层协议（TLS）用于在两个通信应用程序之间提供保密性和数据完整性。)
    - 利用 IP 地址和服务器建立 TCP 连接。
    - 浏览器端会构建请求信息向服务器发送 (请求行、请求头等,并把和该域名相关的 Cookie 等数据附加到请求头中)
    - 服务器接收到请求信息后，会根据请求信息生成响应数据（包括响应行、响应头和响应体等信息），并发给网络进程。
    - 解析响应头的内容了。
        - 状态码：
        1. 如果发现返回的状态码是 301 或者 302  需要重定向
            Location 字段里面读取重定向的地址  发起新的 HTTP 或者 HTTPS 请求
        2. 服务器返回的响应头的状态码是 200，这是告诉浏览器一切正常，可以继续往下处理该请求了。

        - 响应数据类型处理：
            **Content-Type 是 HTTP 头中一个非常重要的字段， 它告诉浏览器服务器返回的响应体数据是什么类型**，然后浏览器会根据 Content-Type 的值来决定如何显示响应体的内容。
        不同 Content-Type 的后续处理流程也截然不同。如果 Content-Type 字段的值被浏览器判断为**下载类型**，那么**该请求会被提交给浏览器的下载管理器，同时该 URL 请求的导航流程就此结束**。但**如果是HTML，那么浏览器则会继续进行导航流程**。
    
# 3. 准备渲染进程 
默认情况下，Chrome 会为每个页面分配一个渲染进程
**如果从一个页面打开了另一个新页面，而新页面和当前页面属于同一站点的话，那么新页面会复用父页面的渲染进程。**这个默认策略叫 process-per-site-instance。
- 打开一个新页面采用的渲染进程策略：
    1. 通常情况下，打开新的页面都会使用单独的渲染进程；
    2. 如果从 A 页面打开 B 页面，且 A 和 B 都属于同一站点的话，那么 B 页面复用 A 页面的渲染进程；如果是其他情况，浏览器进程则会为 B 创建一个新的渲染进程。

# 4. 提交文档
"文档"是指 URL 请求的响应体数据。
- 过程：
    1. “提交文档”的消息是由浏览器进程发出的，渲染进程接收到“提交文档”的消息后，会和网络进程建立传输数据的“管道”。
    2. 等文档数据传输完成之后，渲染进程会返回“确认提交”的消息给浏览器进程。
    3. 浏览器进程在收到“确认提交”的消息后，会更新浏览器界面状态，包括了安全状态、地址栏的 URL、前进后退的历史状态，并更新 Web 页面。
    
# 5. 渲染阶段
1. 文档被提交，渲染进程便开始页面解析和子资源加载了
2. 页面生成完成，渲染进程会发送一个消息给浏览器进程，浏览器接收到消息后，会停止标签图标上的加载动画。

