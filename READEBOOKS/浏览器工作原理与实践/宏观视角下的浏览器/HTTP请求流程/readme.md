### 03 | HTTP请求流程：为什么很多站点第二次打开速度会很快？

HTTP 协议，是建立在 TCP 连接基础之上的。
**HTTP 是一种允许浏览器向服务器获取资源的协议，是 Web 的基础**
**HTTP 也是浏览器使用最广的协议**

## 浏览器端发起 HTTP 请求流程
在浏览器地址栏输入url
1. 构建请求   GET /index.html HTTP1.1
2. 查找缓存   浏览器会先在浏览器缓存中查询是否有要请求的文件
    **浏览器缓存是一种在本地保存资源副本，以供下次请求时直接使用的技术。**
    优点：
    1. 缓解服务器端压力，提升性能(获取资源的耗时更短了)
    2. 对于网站来说，缓存是实现快速资源加载的重要组成部分
如果缓存查找失败，就会进入网络请求过程。
3. 准备 IP 地址和端口
    HTTP 的内容是通过 TCP 的传输数据阶段来实现的。浏览器需要先通过 TCP 与服务器建立连接。
    - 第一步浏览器会请求 DNS 返回域名对应的 IP  浏览器*DNS 数据缓存服务*
    - 获取端口号。如果 URL 没有特别指明端口号，那么 HTTP 协议默认是 80 端口。
4. 等待 TCP 队列
    Chrome 有个机制，同一个域名同时最多只能建立 6 个 TCP 连接
5.  建立 TCP 连接
6. 发送 HTTP 请求
    - 首先浏览器会向服务器发送请求行，它包括了请求方法、请求 URI（Uniform Resource Identifier）和 HTTP 版本协议。
    - 以请求头形式发送其他一些信息，把浏览器的一些基础信息告诉服务器。比如包含了浏览器所使用的操作系统、浏览器内核等信息，以及当前请求的域名信息、浏览器端的 Cookie 信息，等等。
    - 如果使用 POST 方法，那么浏览器还要准备数据给服务器，通过请求体来发送。

## 服务器端处理 HTTP 请求流程

1. 返回请求
    - 首先服务器会返回响应行，包括协议版本和状态码。
        服务器会通过请求行的状态码来告诉浏览器它的处理结果
    - 继续发送响应体的数据
2. 断开连接
    如果浏览器或者服务器在其头信息中加入 
    ```js
    Connection:Keep-Alive 
    ```
    TCP 连接在发送后将仍然保持打开状态，这样浏览器就可以继续通过同一个 TCP 连接发送请求。
    **保持 TCP 连接可以省去下次请求时需要建立连接的时间，提升资源加载速度。**
3. 重定向  *服务器返回响应行和响应头（含重定向格式）.png*
    响应行返回的状态码是 301，状态 301 就是告诉浏览器，我需要重定向到另外一个网址，而需要重定向的网址正是包含在响应头的 Location 字段中，接下来，浏览器获取 Location 字段中的地址，并使用该地址重新导航。

# 为什么很多站点第二次打开速度会很快？
    主要原因是第一次加载页面过程中，缓存了一些耗时的数据。

- 服务器是通过什么方式让浏览器缓存数据的？  
    1. 当服务器返回HTTP 响应头给浏览器时，浏览器是通过响应头中的 Cache-Control 字段来设置是否缓存该资源。
    2. 通过 Cache-Control 中的 Max-age 参数来设置资源缓存过期时长
        ```js
        Cache-Control:Max-age=2000  // 缓存过期时间是 2000 秒
        ```
    3. 如果缓存过期了，浏览器则会继续发起网络请求，并且在HTTP 请求头中带上 
        ```js
        If-None-Match:"4f80f-13c-3a1xb12a"
        ```
        服务器收到请求头后，会根据 If-None-Match 的值来判断请求的资源是否有更新。

# 登录状态是如何保持的？
  1. 用户打开登录页面，在登录框里填入用户名和密码，点击确定按钮。点击按钮会触发页面脚本生成用户登录信息，然后调用 POST 方法提交用户登录信息给服务器。
  2. 服务器接收到浏览器提交的信息之后，查询后台，验证用户登录信息是否正确，如果正确的话，会生成一段表示用户身份的字符串，并把该字符串写到响应头的 Set-Cookie 字段里，如下所示，然后把响应头发送给浏览器。
  ```js
  Set-Cookie: UID=3431uad;
  ```
  3. 浏览器在接收到服务器的响应头后，开始解析响应头，如果遇到响应头里含有 Set-Cookie 字段的情况，浏览器就会把这个字段信息保存到本地。
  4. 当用户再次访问时，浏览器会发起 HTTP 请求，但在发起请求之前，浏览器会读取之前保存的 Cookie 数据，并把数据写进请求头里的 Cookie 字段里（如下所示），然后浏览器再将请求头发送给服务器。
  ```js
  Cookie: UID=3431uad;
  ```
  5. 服务器在收到 HTTP 请求头数据之后，就会查找请求头里面的“Cookie”字段信息，当查找到包含UID=3431uad的信息时，服务器查询后台，并判断该用户是已登录状态，然后生成含有该用户信息的页面数据，并把生成的数据发送给浏览器。
  6. 浏览器在接收到该含有当前用户的页面数据后，就可以正确展示用户登录的状态信息了。